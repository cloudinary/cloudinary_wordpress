<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Source: php/sync/class-unsync.php - Cloudinary Docs</title>

	<script src="scripts/prettify/prettify.js"></script>
	<script src="scripts/prettify/lang-css.js"></script>
	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
	<link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">

	<link
			href="https://fonts.googleapis.com/css?family=IBM+Plex+Mono|IBM+Plex+Sans:300,400|Playfair+Display:900&display=swap"
			rel="stylesheet">
</head>

<body>

<div id="main">

	
	<h1 class="page-title">Source: php/sync/class-unsync.php</h1>
	

	



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>&lt;?php
/**
 * Unsync class for the Cloudinary plugin.
 *
 * @package Cloudinary
 */

namespace Cloudinary\Sync;

use Cloudinary\Plugin;
use Cloudinary\Sync;
use Cloudinary\Media;
use Cloudinary\Sync\Storage;
use WP_Post;

/**
 * Class Unsync
 */
class Unsync {

	/**
	 * Holds the plugin instance.
	 *
	 * @var Plugin Instance of the global plugin.
	 */
	public $plugin;

	/**
	 * Holds the Media instance.
	 *
	 * @var Media
	 */
	protected $media;

	/**
	 * Holds the Sync instance.
	 *
	 * @var Sync
	 */
	protected $sync;

	/**
	 * Holds the Storage instance.
	 *
	 * @var Storage
	 */
	protected $storage;

	/**
	 * Unsync constructor.
	 *
	 * @param Plugin $plugin Global instance of the main plugin.
	 */
	public function __construct( Plugin $plugin ) {
		$this->plugin = $plugin;
	}

	/**
	 * Holds the unsync action keys.
	 */
	const UNSYNC_ACTION = 'cloudinary-unsync';

	/**
	 * Holds the unsync/resync toggle action keys.
	 */
	const UNSYNC_TOGGLE = 'cloudinary-sync-toggle';

	/**
	 * Register any hooks that this component needs.
	 */
	public function setup() {
		$this->media   = $this->plugin->get_component( 'media' );
		$this->sync    = $this->plugin->get_component( 'sync' );
		$this->storage = $this->plugin->get_component( 'storage' );

		if ( 'off' === $this->plugin->settings->get_value( 'auto_sync' ) ) {
			add_action( 'attachment_submitbox_misc_actions', array( $this, 'single_action' ), 11 );
			add_filter( 'handle_bulk_actions-upload', array( $this, 'handle_bulk_actions' ), 11, 3 );
			add_filter( 'media_row_actions', array( $this, 'add_inline_action' ), 10, 2 );
			add_filter( 'bulk_actions-upload', array( $this, 'add_bulk_actions' ) );
		}
	}

	/**
	 * Adds the deliver checkbox on the single image edit screen.
	 *
	 * @param WP_Post $attachment The attachment post object.
	 */
	public function single_action( $attachment ) {
		// Set url for action handling.
		$action_url = add_query_arg(
			array(
				'action'   => self::UNSYNC_TOGGLE,
				'media[]'  => $attachment->ID,
				'_wpnonce' => wp_create_nonce( 'bulk-media' ),
			),
			'upload.php'
		);
		$link_text  = $this->sync->been_synced( $attachment->ID ) ? $this->get_action_text() : __( 'Sync with Cloudinary', 'cloudinary' );
		$status     = $this->sync->filter_media_states( array(), $attachment );
		?>
		&lt;div class="misc-pub-section misc-pub-sync-unsync">
			&lt;?php if ( ! empty( $status ) ) : ?>
				&lt;?php echo esc_html( array_shift( $status ) ); ?>
			&lt;?php else : ?>
				&lt;a href="&lt;?php echo esc_url( $action_url ); ?>">&lt;?php echo esc_html( $link_text ); ?>&lt;/a>
			&lt;?php endif; ?>
		&lt;/div>
		&lt;?php
	}

	/**
	 * Handles bulk actions for attachments.
	 *
	 * @param string $location The location to redirect after.
	 * @param string $action   The action to handle.
	 * @param array  $post_ids Post ID's to action.
	 *
	 * @return string
	 */
	public function handle_bulk_actions( $location, $action, $post_ids ) {

		$actions = array(
			self::UNSYNC_ACTION,
			self::UNSYNC_TOGGLE,
		);

		if ( in_array( $action, $actions, true ) ) {
			switch ( $action ) {
				case self::UNSYNC_ACTION:
					$post_ids = array_filter( $post_ids, array( $this->sync, 'been_synced' ) );
					foreach ( $post_ids as $id ) {
						$this->unsync_attachment( $id );
					}
					break;
				case self::UNSYNC_TOGGLE:
					$attachment_id = array_shift( $post_ids );
					if ( $this->sync->been_synced( $attachment_id ) ) {
						$this->unsync_attachment( $attachment_id );
					} else {
						$this->sync->add_to_sync( $attachment_id );
					}
					$location = get_edit_post_link( $attachment_id, 'edit' );
					break;

			}

			/**
			 * Action to flush delivery caches.
			 *
			 * @hook   cloudinary_flush_cache
			 * @since  3.0.0
			 */
			do_action( 'cloudinary_flush_cache' );
		}

		return $location;
	}

	/**
	 * Add an inline action for manual sync.
	 *
	 * @param array    $actions All actions.
	 * @param \WP_Post $post    The current post object.
	 *
	 * @return array
	 */
	public function add_inline_action( $actions, $post ) {
		if ( $this->sync->been_synced( $post->ID ) ) {

			// Set url for action handling.
			$action_url = add_query_arg(
				array(
					'action'   => self::UNSYNC_ACTION,
					'media[]'  => $post->ID,
					'_wpnonce' => wp_create_nonce( 'bulk-media' ),
				),
				'upload.php'
			);

			// Add link th actions.
			$actions[ self::UNSYNC_ACTION ] = sprintf(
				'&lt;a href="%1$s" aria-label="%2$s">%2$s&lt;/a>',
				$action_url,
				$this->get_action_text()
			);
		}

		return $actions;
	}

	/**
	 * Add bulk actions.
	 *
	 * @param array $actions Current actions to add to.
	 *
	 * @return array
	 */
	public function add_bulk_actions( $actions ) {
		$new_action = array(
			self::UNSYNC_ACTION => $this->get_action_text(),
		);
		$actions    = array_merge( $new_action, $actions );

		return $actions;
	}

	/**
	 * Get the action text.
	 *
	 * @return string
	 */
	protected function get_action_text() {
		return __( 'Unsync from Cloudinary', 'cloudinary' );
	}

	/**
	 * Unsync an attachment from cloudinary.
	 *
	 * @param int $attachment_id The attachment to unsync.
	 */
	public function unsync_attachment( $attachment_id ) {

		$this->sync->set_pending( $attachment_id );
		$cloudinary_id = $this->media->get_cloudinary_id( $attachment_id );
		$url           = $this->media->cloudinary_url( $attachment_id, 'raw', array(), $cloudinary_id, true );
		$url           = remove_query_arg( '_i', $url );
		$storage       = $this->media->get_post_meta( $attachment_id, Sync::META_KEYS['storage'], true );
		if ( 'cld' === $storage || 'dual_low' === $storage ) {
			if ( 'dual_low' === $storage ) {
				$this->storage->remove_local_assets( $attachment_id );
			}

			$file_maybe = get_attached_file( $attachment_id );
			if ( ! file_exists( $file_maybe ) ) {
				remove_filter( 'wp_unique_filename', array( $this->storage, 'unique_filename' ), 10 );
				$date     = get_post_datetime( $attachment_id );
				$download = $this->sync->managers['download']->download_asset( $attachment_id, $url, $date->format( 'Y/m' ) );
				add_filter( 'wp_unique_filename', array( $this->storage, 'unique_filename' ), 10, 3 );
				if ( is_wp_error( $download ) ) {
					wp_die( esc_html( $download->get_error_message() ) );
				}
			}
		}

		// Remove meta data.
		$sync_key  = $this->media->get_public_id_from_url( $url, true );
		$public_id = $this->media->get_public_id( $attachment_id );
		// Delete sync keys.
		delete_post_meta( $attachment_id, '_' . md5( $sync_key ), true );
		delete_post_meta( $attachment_id, '_' . md5( 'base_' . $public_id ), true );
		foreach ( Sync::META_KEYS as $key ) {
			delete_post_meta( $attachment_id, $key );
		}
		$this->sync->set_signature_item( $attachment_id, 'file' );
		/**
		 * Action unsyncing an attachment.
		 *
		 * @hook   cloudinary_unsync_asset
		 * @since  3.0.0
		 *
		 * @param $attachment_id {int}    The attachment ID.
		 */
		do_action( 'cloudinary_unsync_asset', $attachment_id );
	}
}
</code></pre>
        </article>
    </section>




</div>

<nav>
	<h2><a href="index.html">Home</a></h2><h3>Actions</h3><ul><li><a href="cloudinary_connected.html">cloudinary_connected</a></li><li><a href="cloudinary_delete_asset.html">cloudinary_delete_asset</a></li><li><a href="cloudinary_flush_cache.html">cloudinary_flush_cache</a></li><li><a href="cloudinary_id.html">cloudinary_id</a></li><li><a href="cloudinary_init_delivery.html">cloudinary_init_delivery</a></li><li><a href="cloudinary_init_settings.html">cloudinary_init_settings</a></li><li><a href="cloudinary_is_%257B$class_name%257D_active.html">cloudinary_is_{$class_name}_active</a></li><li><a href="cloudinary_lazy_load_bypass.html">cloudinary_lazy_load_bypass</a></li><li><a href="cloudinary_lazy_load_bypass_classes.html">cloudinary_lazy_load_bypass_classes</a></li><li><a href="cloudinary_parse_element.html">cloudinary_parse_element</a></li><li><a href="cloudinary_queue_action.html">cloudinary_queue_action</a></li><li><a href="cloudinary_ready.html">cloudinary_ready</a></li><li><a href="cloudinary_register_sync_types.html">cloudinary_register_sync_types</a></li><li><a href="cloudinary_responsive_images_bypass_formats.html">cloudinary_responsive_images_bypass_formats</a></li><li><a href="cloudinary_string_replace.html">cloudinary_string_replace</a></li><li><a href="cloudinary_unsync_asset.html">cloudinary_unsync_asset</a></li><li><a href="cloudinary_upgrade_asset.html">cloudinary_upgrade_asset</a></li><li><a href="cloudinary_upload_args.html">cloudinary_upload_args</a></li><li><a href="cloudinary_uploaded_asset.html">cloudinary_uploaded_asset</a></li><li><a href="cloudinary_version_upgrade.html">cloudinary_version_upgrade</a></li></ul><h3>Filters</h3><ul><li><a href="cloudinary_admin_image_settings.html">cloudinary_admin_image_settings</a></li><li><a href="cloudinary_admin_pages.html">cloudinary_admin_pages</a></li><li><a href="cloudinary_admin_video_settings.html">cloudinary_admin_video_settings</a></li><li><a href="cloudinary_allowed_extensions.html">cloudinary_allowed_extensions</a></li><li><a href="cloudinary_api_rest_endpoints.html">cloudinary_api_rest_endpoints</a></li><li><a href="cloudinary_apply_breakpoints.html">cloudinary_apply_breakpoints</a></li><li><a href="cloudinary_apply_default_transformations.html">cloudinary_apply_default_transformations</a></li><li><a href="cloudinary_asset_state.html">cloudinary_asset_state</a></li><li><a href="cloudinary_autosync_threads.html">cloudinary_autosync_threads</a></li><li><a href="cloudinary_build_queue_query.html">cloudinary_build_queue_query</a></li><li><a href="cloudinary_bypass_cache.html">cloudinary_bypass_cache</a></li><li><a href="cloudinary_can_sync_asset.html">cloudinary_can_sync_asset</a></li><li><a href="cloudinary_context_options.html">cloudinary_context_options</a></li><li><a href="cloudinary_convert_media_types.html">cloudinary_convert_media_types</a></li><li><a href="cloudinary_converted_url.html">cloudinary_converted_url</a></li><li><a href="cloudinary_cron_frequency.html">cloudinary_cron_frequency</a></li><li><a href="cloudinary_cron_start_offset.html">cloudinary_cron_start_offset</a></li><li><a href="cloudinary_current_post_id.html">cloudinary_current_post_id</a></li><li><a href="cloudinary_default_freeform_transformations_%257B$type%257D.html">cloudinary_default_freeform_transformations_{$type}</a></li><li><a href="cloudinary_default_qf_transformations_%257B$type%257D.html">cloudinary_default_qf_transformations_{$type}</a></li><li><a href="cloudinary_default_transformations.html">cloudinary_default_transformations</a></li><li><a href="cloudinary_delivery_get_id.html">cloudinary_delivery_get_id</a></li><li><a href="cloudinary_doing_upload.html">cloudinary_doing_upload</a></li><li><a href="cloudinary_filter_out_local.html">cloudinary_filter_out_local</a></li><li><a href="cloudinary_gallery_config.html">cloudinary_gallery_config</a></li><li><a href="cloudinary_gallery_html_container.html">cloudinary_gallery_html_container</a></li><li><a href="cloudinary_get_signature.html">cloudinary_get_signature</a></li><li><a href="cloudinary_ignored_class_keywords.html">cloudinary_ignored_class_keywords</a></li><li><a href="cloudinary_ignored_data_keywords.html">cloudinary_ignored_data_keywords</a></li><li><a href="cloudinary_is_content_dir.html">cloudinary_is_content_dir</a></li><li><a href="cloudinary_is_deliverable.html">cloudinary_is_deliverable</a></li><li><a href="cloudinary_is_folder_synced.html">cloudinary_is_folder_synced</a></li><li><a href="cloudinary_is_media.html">cloudinary_is_media</a></li><li><a href="cloudinary_is_uploadable_media.html">cloudinary_is_uploadable_media</a></li><li><a href="cloudinary_lazy_load_bypass_formats.html">cloudinary_lazy_load_bypass_formats</a></li><li><a href="cloudinary_local_url.html">cloudinary_local_url</a></li><li><a href="cloudinary_media_filters.html">cloudinary_media_filters</a></li><li><a href="cloudinary_media_status.html">cloudinary_media_status</a></li><li><a href="cloudinary_media_types.html">cloudinary_media_types</a></li><li><a href="cloudinary_migrate_legacy_meta.html">cloudinary_migrate_legacy_meta</a></li><li><a href="cloudinary_on_demand_sync_limit.html">cloudinary_on_demand_sync_limit</a></li><li><a href="cloudinary_plugin_asset_cache_filters.html">cloudinary_plugin_asset_cache_filters</a></li><li><a href="cloudinary_plugin_asset_cache_inline_types.html">cloudinary_plugin_asset_cache_inline_types</a></li><li><a href="cloudinary_prepare_size.html">cloudinary_prepare_size</a></li><li><a href="cloudinary_preview_types.html">cloudinary_preview_types</a></li><li><a href="cloudinary_queue_threads.html">cloudinary_queue_threads</a></li><li><a href="cloudinary_raw_url.html">cloudinary_raw_url</a></li><li><a href="cloudinary_register_extensions.html">cloudinary_register_extensions</a></li><li><a href="cloudinary_resource_type.html">cloudinary_resource_type</a></li><li><a href="cloudinary_set_usable_asset.html">cloudinary_set_usable_asset</a></li><li><a href="cloudinary_setting_get_value.html">cloudinary_setting_get_value</a></li><li><a href="cloudinary_settings_save_setting.html">cloudinary_settings_save_setting</a></li><li><a href="cloudinary_setup_component_parts.html">cloudinary_setup_component_parts</a></li><li><a href="cloudinary_sync_base.html">cloudinary_sync_base</a></li><li><a href="cloudinary_sync_base_struct.html">cloudinary_sync_base_struct</a></li><li><a href="cloudinary_syncable_delivery_types.html">cloudinary_syncable_delivery_types</a></li><li><a href="cloudinary_task_capability.html">cloudinary_task_capability</a></li><li><a href="cloudinary_task_capability_%257Btask%257D.html">cloudinary_task_capability_{task}</a></li><li><a href="cloudinary_thread_queue_details_query.html">cloudinary_thread_queue_details_query</a></li><li><a href="cloudinary_transformations.html">cloudinary_transformations</a></li><li><a href="cloudinary_upgrade_sequence.html">cloudinary_upgrade_sequence</a></li><li><a href="cloudinary_upload_options.html">cloudinary_upload_options</a></li><li><a href="cloudinary_validate_cloudinary_id.html">cloudinary_validate_cloudinary_id</a></li></ul>
</nav>

<br class="clear">

<footer>
	<a href="https://cloudinary.com/" target="_blank" rel="noopener noreferrer">Cloudinary</a> |
	<a href="https://github.com/cloudinary/cloudinary_wordpress/" target="_blank" rel="noopener noreferrer">Cloudinary
		on GitHub</a>
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
